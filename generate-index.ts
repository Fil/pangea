import {existsSync, writeFileSync} from "node:fs";

const HTTP_ROOT = "http://127.0.0.1:3033";

async function main() {
  const index = await fetch(`${HTTP_ROOT}/_observablehq/minisearch.json`).then((resp) => resp.json());
  const documents: {id: string; title: string; light?: string; dark?: string}[] = [];
  for (const [i, id] of Object.entries(index.documentIds)) {
    const pathLight = `thumbnail${id}-light.png`;
    const pathDark = `thumbnail${id}-dark.png`;
    let hasLight = false;
    let hasDark = false;
    try {
      if (existsSync(`src/${pathLight}`)) hasLight = true;
      if (existsSync(`src/${pathDark}`)) hasDark = true;
    } catch (e) {}
    documents.push({
      id: id as string,
      title: index.storedFields[i].title,
      light: hasLight ? pathLight : undefined,
      dark: hasDark ? pathDark : undefined
    });
  }

  writeFileSync(
    "src/thumbnail/index.md",
    `---
theme: dashboard
title: Gallery
index: false
sidebar: false
comment: Page generated by generate-index.ts
---

<style>
#list {
  margin-top: 2em;
  display: flex;
  flex-wrap: wrap;
  max-width: 100%;
  gap: 10px;
}
#list a {
  display: block;
  position: relative;
  max-width: 320px;
  width: 260px;
  flex-grow: 1;
  height: 195px;
  border: 2px solid var(--theme-foreground-focus);
  font-family: var(--sans-serif);
}
#list a:hover {
  box-shadow: 0 4px 12px var(--theme-foreground-focus);
  transform: translateY(-1px);
}
#list a q {
  position: absolute;
  top: 0;
  left: 0;
  quotes: none;
  padding: 4px 15px;
  background: var(--theme-foreground-focus);
  color: var(--theme-background-alt);
  max-width: 60%;
  border-radius: 0 0 14px;
  line-height: 1.25em;
  max-height: 2.5em;
  overflow: hidden;
  text-overflow: ellipsis;
}
#list a img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
</style>

<div id=list>
${documents
  .map(({id, title, light, dark}) =>
    light && dark
      ? `<a href="..${id}"><picture><source srcset="../${dark}" media="(prefers-color-scheme: dark)"><img src="../${light}" loading="lazy"></picture><q>${title}</q></a>`
      : `<a href="..${id}"><img src="../${light ?? dark}" loading="lazy"><q>${title}</q></a>`
  )
  .join("\n")}
</div>

`
  );
}

main();
